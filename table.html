<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja">

<head>
<title>差分置き場</title>
<!-- icon設定 -->
<link rel="icon" href="icon/120.png" type="image/png">
<link rel="apple-touch-icon" sizes="120x120" href="icon/120.png">

<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="bmstable" content= "header.json" /> <!--　読み込む難易度表のヘッダファイルをここに指定　-->
<link href="style/style.css" rel="stylesheet" type="text/css" media="screen,print" />
<script src="style/jquery-2.0.2.min.js"></script>
</head>



<body>
<a href="index.html"><img src="icon/24.png" alt="Back Home"title="ホームへ戻る"></a> <!-- /aは終了コード(付け忘れないように) -->

<center>
<strong><span style="font-size: 24pt;">差分置き場</span></strong><br>
<br>

<strong><span style="font-size: 12pt;">雑に作っただけなので見づらいのは許してください；；</span></strong><br> 
まいぺーじ<br>
<a href="http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=mypage&playerid=167171&guestmode=1" target="_blank" rel="noopener noreferrer" >IR</a>
<a href="https://boku.tachi.ac/u/sdf/games/bms/7K/scores" target="_blank" rel="noopener noreferrer" >Bokutachi</a><br>
</center>

<br>

<!--　　　　　ここから難易度表本体　　　　　-->
<div class="tableflame">
<table align="center" cellspacing="1" cellpadding=2　border="0" bgcolor="#000000" id="table_int">
</table>
</div>


<script language="javascript" type="text/javascript">
// メニュー開閉
function toggleMenu(tName) {
    const tMenu = document.getElementById(tName).style;
    tMenu.display = (tMenu.display === 'none') ? "block" : "none";
}

// JSONデータを取得してテーブル生成
$(document).ready(function() {
    const bmstableContent = $("meta[name=bmstable]").attr("content"); // 最初に読み込んだ値を保持
    let initialData; // 初期データの保存

    // ボタンコンテナ生成
    const buttonContainer = $("<div class='table-buttons'></div>").insertBefore("#table_int");
    $("<button id='toggleRows'>区切り行を非表示にする</button>").appendTo(buttonContainer)
        .on("click", toggleRowsVisibility);

    $("<button id='resetTable'>元の状態に戻す</button>").appendTo(buttonContainer)
        .on("click", resetTable);

    // JSONデータの取得とテーブル生成
    $.getJSON(bmstableContent)
        .done(function(header) {
            $.getJSON(header.data_url)
                .done(function(data) {
                    initialData = JSON.parse(JSON.stringify(data)); // 深いコピーで保存
                    generateTable(data, header.symbol, header.level);
                })
                .fail(function() {
                    alert("データの取得に失敗しました。");
                });
        })
        .fail(function() {
            alert("ヘッダー情報の取得に失敗しました。");
        });
});

// 区切り行の非表示/表示
function toggleRowsVisibility() {
    const isHidden = $(".tr_separate").is(":hidden");
    $(".tr_separate").toggle();
    $(this).text(isHidden ? "区切り行を非表示にする" : "区切り行を表示する");
}

// テーブルのリセット
function resetTable() {
    if (initialData) {
        $("#table_int").html(""); // テーブルクリア
        generateTable(initialData);
    } else {
        alert("初期データが見つかりません。");
    }
}

// 汎用テーブル生成関数
function generateTable(data, symbol, level = null) {
    const table = $("#table_int");
    table.html(""); // テーブル内容をクリア

    const headers = ["LV", "動画", "譜面", "タイトル(IRリンク)", "作者(敬称略) / 本体リンク", "差分", "BPM", "total", "追加日時", "コメント"];
    const sortableColumns = ["LV", "タイトル(IRリンク)", "作者(敬称略) / 本体リンク", "BPM", "total", "追加日時", "コメント"];
    let sortState = {}; // ソート状態を保持

    // ヘッダー行作成
    const headerRow = $("<tr height='20' style='color:white;background-color:#666666'></tr>");
    headers.forEach((headerText, index) => {
        const cell = $("<td align='center'>" + headerText + "</td>");
        if (sortableColumns.includes(headerText)) {
            cell.css("cursor", "pointer").on("click", () => sortTable(table, index, headerText, sortState));
        }
        headerRow.append(cell);
    });
    table.append(headerRow);

    // データ行作成
    let currentLevel = "";
    let count = 0;
    let separatorRow = null;
    data.forEach(row => {
        if (currentLevel !== row.level) {
            if (separatorRow) {
                separatorRow.html(`<td colspan='11' align='center'><b>${symbol} ${currentLevel} (${count}譜面)</b></td>`);
            }
            currentLevel = row.level;
            separatorRow = $(`<tr class='tr_separate' id='${symbol}${currentLevel}'></tr>`).appendTo(table);
            count = 0;
        }

        const dataRow = $("<tr class='tr_normal'></tr>");
        if (row.state) dataRow.addClass(`state${row.state}`);
        dataRow.append(`<td width='1%'>${symbol} ${currentLevel}</td>`);
        dataRow.append(`<td width='1%' align='center'>${row.youtube ? `<a href='${row.youtube}' target='_blank'><img src='style/youtube.gif' border='0' alt='Youtube' /></a>` : ""}</td>`);
        dataRow.append(`<td width='1%' align='center'><a href='https://bms-score-viewer.pages.dev/view?md5=${row.md5}' target='_blank'>■</a></td>`);
        dataRow.append(`<td width='13%'><a href='http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5=${row.md5}' target='_blank'>${row.title}</a></td>`);
        dataRow.append(`<td width='5%'>${row.artist ? `<a href='${row.url}' target='_blank'>${row.artist}</a>` : ""}</td>`);
        dataRow.append(`<td width='1%'>DL</td>`);
        dataRow.append(`<td width='1%'>${row.bpm}</td>`);
        dataRow.append(`<td width='1%'>${row.total}/${row.totalnote}</td>`);
        dataRow.append(`<td width='1%'>${row.year ? `${row.year}/${row.month || 0}/${row.day || 0}` : "('ω')｡o(?)"}</td>`);
        dataRow.append(`<td width='10%'>${row.comment}</td>`);
        table.append(dataRow);
        count++;
    });

    // 最後の区切り行
    if (separatorRow) {
        separatorRow.html(`<td colspan='11' align='center'><b>${symbol} ${currentLevel} (${count}譜面)</b></td>`);
    }
}

// ソート機能
function sortTable(table, columnIndex, columnName, sortState) {
    const rows = table.find("tr:gt(0)").toArray().sort((rowA, rowB) => {
        const valA = $(rowA).children("td").eq(columnIndex).text();
        const valB = $(rowB).children("td").eq(columnIndex).text();
        if ($.isNumeric(valA) && $.isNumeric(valB)) {
            return valA - valB;
        } else {
            return valA.localeCompare(valB);
        }
    });
    if (!sortState[columnIndex]) rows.reverse();
    table.append(rows);
    sortState[columnIndex] = !sortState[columnIndex];
}
</script>
</body>
</html>