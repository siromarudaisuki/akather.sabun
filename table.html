<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja">

<head>
<title>差分置き場</title>
<!-- icon設定 -->
<link rel="icon" href="icon/120.png" type="image/png">
<link rel="apple-touch-icon" sizes="120x120" href="icon/120.png">

<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="bmstable" content= "header.json" /> <!--　読み込む難易度表のヘッダファイルをここに指定　-->
<link href="style/style.css" rel="stylesheet" type="text/css" media="screen,print" />
<script src="style/jquery-2.0.2.min.js"></script>
</head>



<body>
<a href="index.html"><img src="icon/24.png" alt="Back Home"title="ホームへ戻る"></a> <!-- /aは終了コード(付け忘れないように) -->

<center>
<strong><span style="font-size: 24pt;">差分置き場</span></strong><br>
<br>

<strong><span style="font-size: 12pt;">雑に作っただけなので見づらいのは許してください；；</span></strong><br> 
まいぺーじ<br>
<a href="http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=mypage&playerid=167171&guestmode=1" target="_blank" rel="noopener noreferrer" >IR</a>
<a href="https://boku.tachi.ac/u/sdf/games/bms/7K/scores" target="_blank" rel="noopener noreferrer" >Bokutachi</a><br>
</center>

<br>

<!--　　　　　ここから難易度表本体　　　　　-->
<div class="tableflame">
<table align="center" cellspacing="1" cellpadding=2　border="0" bgcolor="#000000" id="table_int">
</table>
</div>


<script language="javascript" type="text/javascript">

// メニュー開閉
function menu(tName){
	let tMenu = document.getElementById(tName).style;
	if (tMenu.display == 'none')
	{
		tMenu.display = "block";
	}
	else
	{
		tMenu.display = "none";
	}
}

// 'GASを使ってスプレッドシートからjsonに変換した差分情報'を取得
$(document).ready(function(){
	$.getJSON($("meta[name=bmstable]").attr("content"), function(header){
		$.getJSON(header.data_url, function(information){
			// headerのsort有無で分岐
			if(header["level"])
			{
				makeBMSTable(information,header.symbol,header["level"]);
			} 
			else 
			{
				makeBMSTable(information,header.symbol);
			}
		});
	});
});


// BMSテーブル構築
function makeBMSTable(info, mark, order) {
    if (typeof order === 'undefined') order = null;

    let obj = $("#table_int");
    obj.html("");

    // 初期データを保存
    const initialInfo = JSON.parse(JSON.stringify(info)); // 深いコピーでデータを保存

    // ボタンを追加（表の外に配置）
    const buttonContainer = $("<div class='table-buttons'></div>");
    let toggleButton = $("<button id='toggleRows'>区切り行を非表示にする</button>");
    let resetButton = $("<button id='resetTable'>元の状態に戻す</button>");

    toggleButton.on("click", function() {
        let isHidden = $(".tr_separate").is(":hidden");
        $(".tr_separate").toggle();
        $(this).text(isHidden ? "区切り行を非表示にする" : "区切り行を表示する");
    });

    resetButton.on("click", function() {
        // テーブルを初期状態に完全リセット
        obj.html("");
        makeBMSTable(initialInfo, mark, order);
    });

    buttonContainer.append(toggleButton).append(resetButton);
    obj.before(buttonContainer);

    // ヘッダー作成
    let headerRow = $("<tr height='20' style='color:white;background-color:#666666'></tr>");
    let headers = ["LV", "動画", "譜面", "タイトル(IRリンク)", "作者(敬称略)(本体リンク)", "差分", "BPM", "total", "追加日時", "コメント"];
    let sortableIndexes = ["LV", "タイトル(IRリンク)", "作者(敬称略)(本体リンク)", "BPM", "total", "追加日時", "コメント"];
    let sortState = {};

    headers.forEach((text, index) => {
        let headerCell = $("<td align='center'>" + text + "</td>");
        
        // ソート可能なカラムにソート機能を追加
        if (sortableIndexes.includes(text)) {
            headerCell.attr("sortable", true);
            headerCell.css("cursor", "pointer");
            headerCell.on("click", function() {
                sortState[index] = !sortState[index]; // ソート方向を切り替え
                let rows = obj.find("tr:gt(0)").toArray().sort(comparer(index, text, sortState[index]));
                if (!sortState[index]) { rows.reverse(); }

                // ソート中は区切り行を非表示にし、表示ボタンを切り替え
                $(".tr_separate").hide();
                toggleButton.text("元の状態に戻す").off("click").on("click", function() {
                    $(".tr_separate").show();
                    $(this).text("区切り行を非表示にする").off("click").on("click", function() {
                        let isHidden = $(".tr_separate").is(":hidden");
                        $(".tr_separate").toggle();
                        $(this).text(isHidden ? "区切り行を非表示にする" : "区切り行を表示する");
                    });
                });

                // CSSで矢印を追加
                headerRow.find("td").removeClass("sort-asc sort-desc");
                headerCell.addClass(sortState[index] ? "sort-asc" : "sort-desc");

                obj.append(rows);
            });
        }

        headerRow.append(headerCell);
    });

    headerRow.appendTo(obj);

    function comparer(index, columnName, ascending) {
        return function(a, b) {
            let valA = $(a).children("td").eq(index).text();
            let valB = $(b).children("td").eq(index).text();

            if (columnName === "total") {
                return parseFloat(valA) - parseFloat(valB);
            }
            else if (columnName === "追加日時") {
                return new Date(valA) - new Date(valB);
            }
            else if ($.isNumeric(valA) && $.isNumeric(valB)) {
                return valA - valB;
            } else {
                return valA.localeCompare(valB);
            }
        };
    }

    let obj_sep = null;
    let x = "", count = 0;

    for (let i = 0; i < info.length; i++) {
        if (x != info[i].level) {
            if (obj_sep != null) {
                obj_sep.html("<td colspan='11' align='center'><b>" + mark + x + " (" + count + "譜面)</b></td>");
            }
            obj_sep = $("<tr class='tr_separate' id='" + mark + info[i].level + "'></tr>");
            obj_sep.appendTo(obj);
            count = 0;
            x = info[i].level;
        }

        let str = $("<tr class='tr_normal'></tr>");
        if(info[i].state) str = $("<tr class='state" + info[i].state + "'></tr>");

        $("<td width='1%'>" + mark + x + "</td>").appendTo(str);
        $("<td width='1%' align='center'>" + (info[i].youtube ? "<a href='" + info[i].youtube + "' target='_blank'><img src='style/youtube.gif' border='0' alt='Youtube' /></a>" : "") + "</td>").appendTo(str);
        $("<td width='1%' align='center'><a href='https://bms-score-viewer.pages.dev/view?md5=" + info[i].md5 + "' target='_blank'>■</a></td>").appendTo(str);
        $("<td width='13%'><a href='http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5=" + info[i].md5 + "' target='_blank'>" + info[i].title + "</a></td>").appendTo(str);
        $("<td width='5%'>" + (info[i].artist ? "<a href='" + info[i].url + "' target='_blank'>" + info[i].artist + "</a>" : "") + "</td>").appendTo(str);
        $("<td width='1%'>DL</td>").appendTo(str);
        $("<td width='1%'>" + info[i].bpm + "</td>").appendTo(str);
        $("<td width='1%'>" + info[i].total + "</td>").appendTo(str);
        $("<td width='1%'>" + (info[i].year ? (info[i].year + "/" + (info[i].month || "") + "/" + (info[i].day || "")) : "('ω')｡o(?)") + "</td>").appendTo(str);
        $("<td width='10%'>" + info[i].comment + "</td>").appendTo(str);

        str.appendTo(obj);
        count++;
    }

    if (obj_sep != null) {
        obj_sep.html("<td colspan='11' align='center'><b>" + mark + x + " (" + count + "譜面)</b></td>");
    }
}

// 過去の手書きコード
/*
// ソートのための引数追加
function makeBMSTable(info, mark, order) {
	// orderが未指定の場合はnull
	if(typeof order === 'undefined') order = null;
	
    let x = "";
    let ev = "";
    let count = 0;
    let obj = $("#table_int");

	// ソート
	if(order != "" && order != null)
	{
		// herder.jsonにsortが存在する場合は先に指定順->タイトル順にソート
		let orderAry = [];
		for(let l = 0; l < order.length; l++)
		{
			orderAry.push(order[l].toString());
		}
		
		for(let j = 0; j < info.length; j++)
		{
			let index=orderAry.indexOf(info[j]["level"]);
			info[j]["_index"]=index;
		}

		// 譜面情報を 難易度->名前 の優先度でソート
		info.sort(function(a,b)
		{
			if(a["_index"] < b["_index"])      return -1;
			else if(a["_index"] > b["_index"]) return +1;
			else if(a["title"].toLowerCase() < b["title"].toLowerCase() ) return -1;
			else if(a["title"].toLowerCase() > b["title"].toLowerCase() ) return +1;
			else return 0;
		});
		for(let k=0; k < info.length; k++)
		{
			delete info[k]["_index"];
		}
	} 
	else 
	{
		// そうでない場合は レベル順->タイトル順 にソート
		info.sort(
			function(a,b){
				let aLv = a["level"].toString();
				let bLv = b["level"].toString();
				if(isNaN(a["level"]) == false && isNaN(b["level"]) == false)
				{
					return a["level"]-b["level"];
				} 
				else if( aLv < bLv )
				{
					return -1;
				} 
				else if( aLv > bLv )
				{
					return 1;
				} 
				else if( a["title"].toLowerCase() < b["title"].toLowerCase() )
				{
					return -1;
				} 
				else if( a["title"].toLowerCase() > b["title"].toLowerCase() )
				{
					return 1;
				} 
				else 
				{
					return 0;
				}
			}
		);
	}
	
    // カラムの見出し構築
    obj.html("");
    $("<tr height='20' style='color:white;background-color:#666666'>"
		+"<td align='center' sortable>LV</td>"
		+"<td align='center' sortable>動<br>画</td>"
		+"<td align='center' sortable>譜<br>面</td>"
		+"<td align='center' sortable>タイトル<br>(IRリンク)</td>"
		+"<td align='center' sortable>作者(敬称略)<br>(本体リンク)</td>"
		+"<td align='center' sortable>差分</td>"
		+"<td align='center' sortable>BPM</td>"
		+"<td align='center' sortable>total</td>"
		+"<td align='center' sortable>追加日時</td>"
		+"<td align='center' sortable>コメント</td>"
		+"</tr>").appendTo(obj);

    let obj_sep = null;
    for (let i = 0; i < info.length; i++) 
	{
        // 難度ごとの区切り
        if (x != info[i].level) 
		{
            // 前の区切りに譜面数、平均密度を追加
			// if (obj_sep != null) 
			// {
            //     obj_sep.html("<td colspan=11 align='center'>" + "<b>" + mark + x + " (" + count + "譜面)</b></td>");
            // }
            obj_sep = $("<tr class='tr_separate' id='" + mark + info[i].level + "'></tr>");
            obj_sep.appendTo(obj);
            count = 0;
            x = info[i].level;
        }

        // 本文
        let str = $("<tr class='tr_normal'></tr>");
        if(info[i].state == 1) 
		{
			str = $("<tr class='state1'></tr>");
        }
        if(info[i].state == 2) 
		{
			str = $("<tr class='state2'></tr>");
        }
        if(info[i].state == 3) 
		{
			str = $("<tr class='state3'></tr>");
        }
        if(info[i].state == 4) 
		{
			str = $("<tr class='state4'></tr>");
        }
        if(info[i].state == 5) 
		{
			str = $("<tr class='state5'></tr>");
        }
        if(info[i].state == 6) 
		{		
			str = $("<tr class='state6'></tr>");
		}

        // レベル表記
        $("<td width='1%'>" + mark + x + "</td>").appendTo(str);

        // 動画
		if(info[i].youtube != "" && info[i].youtube != null)
		{
			// YouTube
			$("<td width='1%' align='center'><a href='" + info[i].youtube + "' target='_blank'><img src='style/youtube.gif' border='0' alt='Youtube' /></a></td>").appendTo(str);
		} 
		else if(info[i].video != "" && info[i].video != null)
		{
			// video
			$("<td width='1%' align='center'><a href='http://video.com/" + info[i].video + "' target='_blank'><img src='style/video.gif' border='0' alt='video' /></a></td>").appendTo(str);
		} 
		else 
		{
			$("<td width='1%'></td>").appendTo(str);
		}

		// 譜面画像
		$("<td width='1%' akign='center'><a href='https://bms-score-viewer.pages.dev/view?md5=" + info[i].md5 + "' target='_blank'> ■</a></td>").appendTo(str);

        // タイトル
		if(info[i].state != "")
		{
			if (info[i].state == 3) // 新規追加
			{
				$("<td width='13%'>" + "<a href='http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5=" 
				+ info[i].md5 + "' target='_blank'>" + info[i].title + " <br>＊新規追加＊" + "</a></td>").appendTo(str);
			}
			else if (info[i].state == 1) // 未公開
			{
				$("<td width='13%'>" + "<a href='http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5=" 
				+ info[i].md5 + "' target='_blank'>" + info[i].title + " <br>＊未公開＊" + "</a></td>").appendTo(str);
			}
		}
        else
		{ 
			// 
			$("<td width='13%'>" + "<a href='http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5=" + info[i].md5 + "' target='_blank'>" + info[i].title + "</a></td>").appendTo(str);
		}
		
		// アーティスト
        let astr = "";
        if(info[i].url != "" && info[i].url != null) {
			if(info[i].artist != "" && info[i].artist != null) 
			{
				astr = "<a href='" + info[i].url + "' target='_blank" + "'>" + info[i].artist + "</a>";
			}
			else 
			{
				astr = "<a href='" + info[i].url + "' target='_blank" + "'>" + info[i].url + "</a>";
			}
        } 
		else 
		{
			if(info[i].artist != "" && info[i].artist != null) 
			{
				astr = info[i].artist;
			}
        }

		// URL
        if(info[i].url_pack != "" && info[i].url_pack != null) 
		{
            if(info[i].name_pack != "" && info[i].name_pack != null) 
			{
            astr += "<br />(<a href='" + info[i].url_pack + "'>" + info[i].name_pack + "</a>)";
            } 
			else 
			{
				astr += "<br />(<a href='" + info[i].url_pack + "'>" + info[i].url_pack + "</a>)";
            }
        } 
		else 
		{
			if(info[i].name_pack != "" && info[i].name_pack != null) 
			{
				astr += "<br />(" + info[i].name_pack + ")";
			}
        }
        $("<td width='5%'>" + astr + "</td>").appendTo(str);

        // 差分
        // if(info[i].url_diff != "" && info[i].url_diff != null) {
        //	if(info[i].name_diff != "" && info[i].name_diff != null) {
	    //    $("<td width='1%'><a href='" + info[i].url_diff + "'>" + info[i].name_diff + "</a></td>").appendTo(str);
        //	} else {
	    //    $("<td width='1%'><a href='" + info[i].url_diff + "'>" + "DL" + "</a></td>").appendTo(str);
        //	}
        //} else {
        //	if(info[i].name_diff != "" && info[i].name_diff != null) {
	    //    $("<td width='1%'>" + info[i].name_diff + "</td>").appendTo(str);
        //	} else {
	    //    $("<td width='1%'></td>").appendTo(str);
        //	}
        //}
		// levelとタイトル情報を使ってGithub上からDL
		if (info[i].state == 1)
		{
			$("<td width='1%'> </td>").appendTo(str);
		}
		else
		{
			$("<td width='1%'><a href='sabun/★" + info[i].level + " " + info[i].title + ".zip'>" + "DL" + "</a></td>").appendTo(str);
		}

		// BPM
		$("<td width='1%'>" + info[i].bpm + "</div></td>").appendTo(str);
		// トータル
		$("<td width='1%'>" + info[i].total + "/" + info[i].totalnote + "</div></td>").appendTo(str);
		// 日付
		if (info[i].year)
		{
			let text = info[i].year;
			if (info[i].month) { text += ("/" + info[i].month); }
			if (info[i].day) { text += ("/" + info[i].day); }
			$("<td width='1%'>" + text + "</div></td>").appendTo(str);
		}
		else
		{
			// なんか入れとかないとコメントが追加日時の方に挿入されてしまう；；
			$("<td width='1%'><font color='#666666'>('ω')｡o(?)</color></div></td>").appendTo(str);
		}
        // コメント
        $("<td width='10%'>" + info[i].comment + "</div></td>").appendTo(str);

        str.appendTo(obj);
        count++;
    }
    
    // 最後の区切り処理(マークが抜け落ちてたので追加)
    if (obj_sep != null) 
	{
        obj_sep.html("<td colspan='11' align='center'>" + "<b>" + mark + x + " (" + count + "譜面)</b></td>");
	}
}
*/
</script>


</body>
</html>
