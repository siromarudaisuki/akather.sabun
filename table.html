<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja">

<head>
<title>差分置き場</title>
<!-- icon設定 -->
<link rel="icon" href="icon/120.png" type="image/png">
<link rel="apple-touch-icon" sizes="120x120" href="icon/120.png">

<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="bmstable" content= "header.json" /> <!--　読み込む難易度表のヘッダファイルをここに指定　-->
<link href="style/style.css" rel="stylesheet" type="text/css" media="screen,print" />
<script src="style/jquery-2.0.2.min.js"></script>
</head>



<body>
<a href="index.html"><img src="icon/24.png" alt="Back Home"title="ホームへ戻る"></a> <!-- /aは終了コード(付け忘れないように) -->

<center>
<strong><span style="font-size: 24pt;">差分置き場</span></strong><br>
<br>

<strong><span style="font-size: 12pt;">雑に作っただけなので見づらいのは許してください；；</span></strong><br> 
まいぺーじ<br>
<a href="http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=mypage&playerid=167171&guestmode=1" target="_blank" rel="noopener noreferrer" >IR</a>
<a href="https://boku.tachi.ac/u/sdf/games/bms/7K/scores" target="_blank" rel="noopener noreferrer" >Bokutachi</a><br>
</center>

<br>

<!--　　　　　ここから難易度表本体　　　　　-->
<div class="tableflame">
<table align="center" cellspacing="1" cellpadding=2　border="0" bgcolor="#000000" id="table_int">
</table>
</div>


<script language="javascript" type="text/javascript">

	// メニュー開閉
	function toggleMenu(tName) {
		const tMenu = document.getElementById(tName).style;
		tMenu.display = (tMenu.display === 'none') ? "block" : "none";
	}
	
	$(document).ready(function () {
		const bmstableContent = $("meta[name=bmstable]").attr("content"); // Initial data retrieval
		let initialData; // Variable to store initial data
	
		// Button generation
		const buttonContainer = $("<div class='table-buttons'></div>").insertBefore("#table_int");
		const toggleButton = $("<button id='toggleRows'>区切り行を非表示にする</button>").appendTo(buttonContainer).on("click", toggleRowsVisibility);
		const resetButton = $("<button id='resetTable'>元の状態に戻す</button>").appendTo(buttonContainer).on("click", resetTable);
	
		// Fetch JSON data
		$.getJSON(bmstableContent)
			.done(function (header) {
				$.getJSON(header.data_url)
					.done(function (data) {
						initialData = JSON.parse(JSON.stringify(data)); // Deep copy of the initial data
						generateTable(data, header.symbol, header.level);
					})
					.fail(function () {
						alert("データの取得に失敗しました。");
					});
			})
			.fail(function () {
				alert("ヘッダー情報の取得に失敗しました。");
			});
	
		// Sort button behavior handler
		function handleSortButtonDisplay(sortApplied) {
			if (sortApplied) {
				resetButton.show();
				toggleButton.hide();
			} else {
				resetButton.hide();
				toggleButton.show();
			}
		}
	});
	
	// Generate BMS Table
	function generateTable(data, symbol, level = null) {
		const table = $("#table_int");
		table.html(""); // Clear table
	
		const headers = ["LV", "動画", "譜面", "タイトル(IRリンク)", "作者(敬称略) / 本体リンク", "差分", "BPM", "total", "追加日時", "コメント"];
		const sortableColumns = ["LV", "タイトル(IRリンク)", "作者(敬称略) / 本体リンク", "BPM", "total", "追加日時", "コメント"];
		const sortState = {};
	
		// Create header row
		const headerRow = $("<tr height='20' style='color:white;background-color:#666666'></tr>");
		headers.forEach((headerText, index) => {
			const cell = $("<td align='center'>" + headerText + "</td>");
			if (sortableColumns.includes(headerText)) {
				cell.addClass("sortable-column").on("click", () => sortTable(table, index, headerText, sortState));
			}
			headerRow.append(cell);
		});
		table.append(headerRow);
	
		// Generate data rows
		let currentLevel = "";
		let count = 0;
		let separatorRow = null;
		data.forEach(row => {
			if (currentLevel !== row.level) {
				if (separatorRow) {
					separatorRow.html(`<td colspan='11' align='center'><b>${symbol} ${currentLevel} (${count}譜面)</b></td>`);
				}
				currentLevel = row.level;
				separatorRow = $(`<tr class='tr_separate' id='${symbol}${currentLevel}'></tr>`).appendTo(table);
				count = 0;
			}
	
			const rowElement = $("<tr></tr>");
			Object.values(row).forEach(cellValue => {
				rowElement.append(`<td>${cellValue}</td>`);
			});
			table.append(rowElement);
			count++;
		});
	
		if (separatorRow) {
			separatorRow.html(`<td colspan='11' align='center'><b>${symbol} ${currentLevel} (${count}譜面)</b></td>`);
		}
	}
	
	// Sort function
	function sortTable(table, columnIndex, columnName, sortState) {
		const rows = table.find("tr:gt(0)").toArray(); // Data rows
		const separatorRows = $(".tr_separate"); // Separator rows
	
		separatorRows.hide(); // Hide separator rows
	
		rows.sort((rowA, rowB) => {
			const valA = $(rowA).children("td").eq(columnIndex).text();
			const valB = $(rowB).children("td").eq(columnIndex).text();
	
			if (columnName === "追加日時") {
				const aDateParts = valA.split("/").map(num => parseInt(num) || 0);
				const bDateParts = valB.split("/").map(num => parseInt(num) || 0);
	
				for (let i = 0; i < Math.min(aDateParts.length, bDateParts.length); i++) {
					if (aDateParts[i] !== bDateParts[i]) {
						return sortState[columnIndex] ? bDateParts[i] - aDateParts[i] : aDateParts[i] - bDateParts[i];
					}
				}
				return 0;
			}
	
			if ($.isNumeric(valA) && $.isNumeric(valB)) {
				return sortState[columnIndex] ? valB - valA : valA - valB;
			}
	
			return sortState[columnIndex] ? valB.localeCompare(valA) : valA.localeCompare(valB);
		});
	
		table.append(rows);
	
		const headerCells = table.find("tr:first-child td.sortable-column");
		headerCells.removeClass("sort-asc sort-desc");
		const targetHeaderCell = headerCells.eq(columnIndex);
		targetHeaderCell.addClass(sortState[columnIndex] ? "sort-asc" : "sort-desc");
	
		sortState[columnIndex] = !sortState[columnIndex]; // Toggle state
	}
</script>
</body>
</html>